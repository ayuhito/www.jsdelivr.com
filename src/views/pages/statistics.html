<link rel="ractive" href="../r-page.html" />
<link rel="ractive" href="../components/coming-soon.html" name="c-coming-soon"/>
<link rel="ractive" href="../components/header.html" name="c-header" />
<link rel="ractive" href="../components/footer.html" name="c-footer" />
<link rel="ractive" href="../components/notification.html" name="c-notification"/>
<link rel="ractive" href="../components/stats-table.html" name="c-stats-table"/>

<link rel="ractive" href="../components/network-provider-stats.html" name="c-network-provider-stats" />
<link rel="ractive" href="../components/network-request-chart.html" name="c-network-request-chart" />
<link rel="ractive" href="../components/top-platform-browser.html" name="c-top-platform-browser" />
<link rel="ractive" href="../components/statistics-project-table.html" name="c-statistics-project-table" />

<r-page noYield="{{noYield}}" title="{{title}}" description="{{description}}">
	<c-notification></c-notification>
	<c-header></c-header>
	<div class="p-statistics">
		<div class="container">
			<div class="head-wrapper">
				<img
					class="head-map-bg"
					width="800"
					height="428"
					src="{{@shared.assetsHost}}/img/sponsors/map.svg"
				/>
				<h2 class="head-title">Statistics</h2>
				<p class="head-text">
					Global internet insights from jsDelivr based on anonymous
					aggregated data
				</p>
				<div class="global_data">
					<div class="global_data_info">
						<img
							width="44"
							height="48"
							src="{{@shared.assetsHost}}/img/statistics/globalData.svg"
							loading="lazy"
						/>
						<h2 class="title">Global data</h2>
					</div>
					<div class="header-ctrls">
						<div class="data-range-ctrl">
							<div class="btn-group">
								<span class="label-for-pinned">Data range</span>
								<button
									type="button"
									class="btn dropdown-toggle"
									data-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false"
								>
									<span>{{ globalStatsPeriod }}</span>
									<i
										class="fa fa-angle-down"
										aria-hidden="true"
									></i>
								</button>

								<ul class="dropdown-menu">
									{{#each statsPeriods}}
									<li>
										<a
											on-click="@this.set('globalStatsPeriod', @key)"
											>{{@key}}</a
										>
									</li>
									{{/each}}
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="verticalLine" />
				<c-network-provider-stats period="{{ globalStatsPeriod }}"></c-network-provider-stats>
				<div class="hit-rate">
					<h3>Cache hit rate</h3>
					<div class="rate-row">
						{{#each rateList}}
						<div class="row-item">
							<div>
								<img
									class="icon"
									width="24"
									height="24"
									src='{{@shared.assetsHost}}{{svg}}'
								/>
								<span>{{name}}</span>
							</div>
							<div class="interest"><p class="text-table-number">{{interest}}</p></div>
						</div>
					  {{/each}}
					</div>
				</div>
			</div>
		</div>
		<div class="grey">
			<div class="container">
				<div class="network-data">
					<div class="network-data-info">
						<img
							width="44"
							height="48"
							src="{{@shared.assetsHost}}/img/statistics/network.svg"
							loading="lazy"
						/>
						<h2 class="title">Network data</h2>
					</div>
					<div class="network-data-action">
						<input class="search" placeholder="Filter for a specific country or a continent..."/>
						<div class="data-range-ctrl">
							<div class="btn-group">
								<div class="eac-item WW" on-click="@this.setCountryAsGlobal()"><img src="/img/statistics/flags/WW.svg"/>Global</div>
								<span class="label-for-pinned">Data range</span>
								<button
									type="button"
									class="btn dropdown-toggle"
									data-toggle="dropdown"
									aria-haspopup="true"
									aria-expanded="false"
								>
									<span>{{ networkStatsPeriod }}</span>
									<i
										class="fa fa-angle-down"
										aria-hidden="true"
									></i>
								</button>

								<ul class="dropdown-menu">
									{{#each statsPeriods}}
									<li>
										<a
											on-click="@this.set('networkStatsPeriod', @key)"
											>{{@key}}</a
										>
									</li>
									{{/each}}
								</ul>
							</div>
						</div>
					</div>
				</div>
				<div class="verticalLine" />
				<c-network-request-chart __ready="{{ __ready }}" period="{{ networkStatsPeriod }}" country="{{ country }}"></c-network-request-chart>
				<div class="map"></div>
				<div class="tops">
					<c-top-platform-browser __ready="{{ __ready }}" type="platform"></c-top-platform-browser>
					<c-top-platform-browser __ready="{{ __ready }}" type="browser"></c-top-platform-browser>
				</div>
			</div>
		</div>
		<div class="container">
			<div class="projects-data">
				<div class="projects_data_info">
					<img
						width="44"
						height="48"
						src="{{@shared.assetsHost}}/img/statistics/projects.svg"
						loading="lazy"
					/>
					<h2 class="title">Projects statistics</h2>
				</div>
				<div class="data-range-ctrl">
					<div class="btn-group">
						<button
							type="button"
							class="btn dropdown-toggle"
							data-toggle="dropdown"
							aria-haspopup="true"
							aria-expanded="false"
						>
							<span>{{ projectStatsPeriod }}</span>
							<i
								class="fa fa-angle-down"
								aria-hidden="true"
							></i>
						</button>

						<ul class="dropdown-menu">
							{{#each statsPeriods}}
							<li>
								<a
									on-click="@this.set('projectStatsPeriod', @key)"
									>{{@key}}</a
								>
							</li>
							{{/each}}
						</ul>
					</div>
				</div>
			</div>
			<div class="verticalLine" />
			<c-statistics-project-table __ready="{{ __ready }}" title="Most popular projects" type="popular" period="{{ projectStatsPeriod }}"></c-statistics-project-table>
			<c-statistics-project-table __ready="{{ __ready }}" title="Trending projects" type="trending" period="{{ projectStatsPeriod }}"></c-statistics-project-table>
		</div>
	</div>
	<c-footer></c-footer>
</r-page>

<script>
	const _ = require('../../public/js/_');
	const tooltip = require('../../public/js/decorators/tooltip');
	const countries = require('../../public/json/countries.json');

	component.exports = {
		data () {
			return {
				_,
				desc: true,
				title: 'Usage statistics - jsDelivr',
				name: 'd3',
				description: 'Load modern JavaScript packages built for you on-demand. Works in modern web browsers, node.js, and deno.',
				statsPeriods: {
					day: 1,
					week: 7,
					month: 30,
					year: 365,
				},
				globalStatsPeriod: "month",
				rateList: [
					{ 
						svg: '/img/statistics/cloudflare.svg',
						name: 'Cloudflare', 
						interest: '99.99%' 
					}, 
					{ 
						svg: '/img/statistics/fastly.svg', 
						name: 'Fastly', 
						interest: '99.98%' 
					},
					{ 
						svg: '/img/statistics/g-core.svg', 
						name: 'G-Core', 
						interest: '99.81%' 
					}
				],
				country: "",
				networkStatsPeriod: "month",
				projectStatsPeriod: "month"
			};
		},
		decorators: {
			tooltip,
		},
		onrender () {
			let $this = this;
			let flagIconPath = "/img/statistics/flags";
			let options = {
				data: countries,
				getValue: "name",
				list: {
					match: {
						enabled: true
					},
					maxNumberOfElements: 15,
					onClickEvent: function() {
						let code = $(".search").getSelectedItemData().code;
						
						$this.set("country", code);
					},
					onShowListEvent: function() {
						$(".search").removeAttr('style');

						$(".eac-item.WW").show();
					},
					onHideListEvent: function() {
						let selectedCode = $this.get("country");
						if(selectedCode) {
							$(".search").css({
								"background-image": `url('${flagIconPath}/${selectedCode}.svg')`,
								"background-size": "17px"
							})
						}

						$(".eac-item.WW").hide();
					},
					onMouseOutEvent: function() {
						$(".easy-autocomplete-container li.selected").removeClass("selected");
					}
				},
				template: {
					type: "custom",
					method: function(value, item) {
						return `<img src="${flagIconPath}/${item.code}.svg"/>` + value;
					}
				},
				theme: "round"
			};

			$(".search").easyAutocomplete(options);

			// move rendered Global autocomplete item into autocomplete container after building autocomplete...
			$(".eac-item.WW").detach().prependTo(".easy-autocomplete-container");
		},
		oncomplete() {
			let el = this.find(".global_data");
			this.stickyObserve(el);
			el = this.find(".network-data");
			this.stickyObserve(el);
		},
		stickyObserve(el) {
			let observer = new IntersectionObserver( ([e]) => e.target.classList.toggle("is-pinned", e.intersectionRatio < 1),
  				{ threshold: [1] }
			);
			observer.observe(el);
		},
		setCountryAsGlobal() {				// set country as <Global>
			$('.search').val('Global');
			this.set('country', 'WW');
		}
	};
</script>
